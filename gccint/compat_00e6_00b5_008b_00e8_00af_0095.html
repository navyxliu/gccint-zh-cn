<html lang="zh">
<head>
<title>compat测试 - GNU Compiler Collection (GCC) Internals</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="GNU Compiler Collection (GCC) Internals">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="_00e6_00b5_008b_00e8_00af_0095_00e5_008c_0085.html#g_t_00e6_00b5_008b_00e8_00af_0095_00e5_008c_0085" title="测试包">
<link rel="prev" href="profopt_00e6_00b5_008b_00e8_00af_0095.html#profopt_00e6_00b5_008b_00e8_00af_0095" title="profopt测试">
<link rel="next" href="Torture_00e6_00b5_008b_00e8_00af_0095.html#Torture_00e6_00b5_008b_00e8_00af_0095" title="Torture测试">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
版权 (C) 1988, 1989, 1992, 1993, 1994, 1995, 1996, 1997, 1998,
1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008 自由软件基金会

您可以依据自由软件基金会所发行的GNU自由文档授权1.2版本或者之后的任何版本，
对本文档进行复制，分发和/或修改；其中不可变章节为"资助自由软件"，封面文
字为 (a) (参见下面)，以及封底文字为 (b) (参见下面)。授权的副本要被包含在
标题为"GNU自由文档授权"的章节中。

(a) FSF的封面文字为：

     GNU 手册

(b) FSF的封底文字为：

     您可以自由复制和修改本GNU手册，如同GNU软件。由自由软件基金会所发行
     的副本用于为GNU开发筹集资金。-->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="compat%e6%b5%8b%e8%af%95"></a>
<a name="compat_00e6_00b5_008b_00e8_00af_0095"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="Torture_00e6_00b5_008b_00e8_00af_0095.html#Torture_00e6_00b5_008b_00e8_00af_0095">Torture测试</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="profopt_00e6_00b5_008b_00e8_00af_0095.html#profopt_00e6_00b5_008b_00e8_00af_0095">profopt测试</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="_00e6_00b5_008b_00e8_00af_0095_00e5_008c_0085.html#g_t_00e6_00b5_008b_00e8_00af_0095_00e5_008c_0085">测试包</a>
<hr>
</div>

<h4 class="subsection">6.4.8 对二进制兼容性测试的支持</h4>

<p>文件<samp><span class="file">compat.exp</span></samp>提供了对二进制兼容性测试的语言无关的支持。
它支持测试遵循相同ABI的两个编译器，或者编译器选项的多个集合，
在一起工作时不影响二进制兼容性。它是打算用来补充ABI测试包的。

 <p>该框架支持的测试具有三部分，分别在不同的源文件中：主程序，
和两个相互作用来拆分要测试的功能的部分。

     <dl>
<dt><samp><var>testname</var><span class="file">_main.</span><var>suffix</var></samp><dd>包含了主程序，其调用了文件<samp><var>testname</var><span class="file">_x.</span><var>suffix</var></samp>中的函数。

     <br><dt><samp><var>testname</var><span class="file">_x.</span><var>suffix</var></samp><dd>包含了至少一个对<samp><var>testname</var><span class="file">_y.</span><var>suffix</var></samp>中的函数的调用。

     <br><dt><samp><var>testname</var><span class="file">_y.</span><var>suffix</var></samp><dd>与<samp><var>testname</var><span class="file">_x.</span><var>suffix</var></samp>共享数据，或者从中获得参数。
</dl>

 <p>每个测试中，主程序和一个功能部分由测试GCC编译。
另一部分可以由一个候选编译器来编译。如果没有指定候选编译器，
则所有的这三个源文件都由测试 GCC编译。你可以指定一个编译器选项对。
每一对中第一个元素指定了测试GCC使用的选项，第二个元素用于候选编译器。
每个测试都是用这些选项来编译。

 <p><samp><span class="file">compat.exp</span></samp>定义了缺省的一对编译器选项。
这些可以通过定义环境变量<samp><span class="env">COMPAT_OPTIONS</span></samp>来取代，如：

<pre class="smallexample">     COMPAT_OPTIONS="[list [list {<var>tst1</var>} {<var>alt1</var>}]
       ...[list {<var>tstn</var>} {<var>altn</var>}]]"
</pre>
 <p>其中<var>tsti</var>和<var>alti</var>是选项列表，要测试的编译器使用<var>tsti</var>，
候选的编译器使用<var>alti</var>。例如，
对于<code>[list [list {-g -O0} {-O3}] [list {-fpic} {-fPIC -O2}]]</code>，
测试会首先被要测试的编译器使用<samp><span class="option">-g -O0</span></samp>来编译，
并且被候选编译器使用<samp><span class="option">-O3</span></samp>来编译。测试在第二次的时候，
测试编译器会使用<samp><span class="option">-fpic</span></samp>，候选编译器会使用<samp><span class="option">-fPIC -O2</span></samp>。

 <p>候选编译器通过将环境变量定义为安装的编译的全路径名来指定；对于C，
定义<samp><span class="env">ALT_CC_UNDER_TEST</span></samp>，对于C++，定义<samp><span class="env">ALT_CXX_UNDER_TEST</span></samp>。
这些将被写入DejaGnu使用的<samp><span class="file">site.exp</span></samp>文件中。缺省情况，是由要测试的编译器，
使用<samp><span class="env">COMPAT_OPTIONS</span></samp>中每个编译选项对的第一个，来构建每个测试。
当<samp><span class="env">ALT_CC_UNDER_TEST</span></samp>或<samp><span class="env">ALT_CXX_UNDER_TEST</span></samp>为<code>same</code>时，
每个测试将使用测试编译来构建，但是使用<samp><span class="env">COMPAT_OPTIONS</span></samp>中的选项组合。

 <p>若要对要测试的编译器和另一版本的使用指定编译选项的GCC，
只运行C++兼容性测试包，则在<samp><var>objdir</var><span class="file">/gcc</span></samp>下执行下列命令：

<pre class="smallexample">     rm site.exp
     make -k \
       ALT_CXX_UNDER_TEST=${alt_prefix}/bin/g++ \
       COMPAT_OPTIONS="lists as shown above" \
       check-c++ \
       RUNTESTFLAGS="compat.exp"
</pre>
 <p>如果一个测试当源文件由不同编译器编译的时候执行失败，
而当文件由同一编译器编译的时候执行成功，则表明生成代码或运行时支持不兼容。
如果一个测试对于候选编译器执行失败，但对于测试编译器却执行成功，
则可能是因为一个bug在测试编译器中已经被修改好，但还存在于候选编译器中。

 <p>二进制兼容性测试支持少数在测试文件的注释中出现的测试框架命令。

     <dl>
<dt><code>dg-require-*</code><dd>这些命令可以用于<samp><var>testname</var><span class="file">_main.</span><var>suffix</var></samp>中，
使得当目标机上没有特定支持的时候跳过测试。

     <br><dt><code>dg-options</code><dd>指定选项用于编译该特定的源文件，将选项添加到<samp><span class="env">COMPAT_OPTIONS</span></samp>中。
当该命令出现在<samp><var>testname</var><span class="file">_main.</span><var>suffix</var></samp>中时，
选项还用于链接测试程序的时候。

     <br><dt><code>dg-xfail-if</code><dd>该命令可以用在第二个源文件中，来指定在特定目标机上对于特定选项，编译将会失败。
</dl>

 </body></html>

